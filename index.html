<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circl Chat - منصة الدردشة المتطورة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --secondary-light: #f472b6;
            --secondary-dark: #db2777;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f9fafb;
            --bronze: #cd7f32;
            --silver: #c0c0c0;
            --gold: #fbbf24;
            --diamond: #60a5fa;
            --king: #a855f7;
            --queen: #ec4899;
            --owner: #dc2626;
            --admin: #059669;
            --moderator: #3b82f6;
            --vip: #f59e0b;
            --user: #6b7280;
            --therapist: #8b5cf6;
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
            --gradient-secondary: linear-gradient(135deg, #fbbf24 0%, #f97316 100%);
            --gradient-dark: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            --gradient-therapist: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius-sm: 0.375rem;
            --radius: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #1f2937;
            line-height: 1.6;
            padding: 1rem;
        }

        .container {
            width: 100%;
            max-width: 1800px;
            height: 95vh;
            background: white;
            border-radius: var(--radius-2xl);
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            display: flex;
        }

        /* شريط التنقل الجانبي */
        .sidebar {
            width: 350px;
            background: #111827;
            color: white;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .user-profile {
            padding: 1.5rem;
            border-bottom: 1px solid #374151;
            background: rgba(255, 255, 255, 0.05);
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            margin: 0 auto 1rem;
            border: 3px solid;
            position: relative;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .online-status {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 15px;
            height: 15px;
            background: var(--success);
            border-radius: 50%;
            border: 2px solid #111827;
        }

        .username {
            font-size: 1.25rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .user-role {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 0 auto;
        }

        .role-owner { background: var(--owner); }
        .role-admin { background: var(--admin); }
        .role-moderator { background: var(--moderator); }
        .role-vip { background: var(--vip); }
        .role-user { background: var(--user); }

        /* قائمة الغرف */
        .rooms-section {
            padding: 1.5rem;
            flex: 1;
            overflow-y: auto;
        }

        .room-list {
            list-style: none;
        }

        .room-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: var(--radius-lg);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .room-item:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.2);
        }

        .room-item.active {
            background: rgba(99, 102, 241, 0.15);
            border-right: 4px solid var(--primary);
        }

        /* منطقة الدردشة الرئيسية */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(180deg, #f9fafb 0%, #f3f4f6 100%);
        }

        .chat-header {
            padding: 1rem 2rem;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .messages-container {
            flex: 1;
            padding: 1.5rem 2rem;
            overflow-y: auto;
        }

        .message {
            display: flex;
            margin-bottom: 1rem;
            animation: fadeIn 0.3s ease;
        }

        .message-content {
            background: white;
            padding: 1rem;
            border-radius: var(--radius-lg);
            max-width: 70%;
            box-shadow: var(--shadow);
        }

        .message-input-container {
            padding: 1rem 2rem;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        /* نوافذ التسجيل */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .auth-box {
            background: white;
            padding: 2rem;
            border-radius: var(--radius-2xl);
            width: 90%;
            max-width: 500px;
            animation: popIn 0.3s ease;
        }

        .tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: var(--radius-lg);
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-lg);
            font-family: 'Tajawal', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-block {
            width: 100%;
        }

        /* نافذة الإدارة */
        .admin-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 2000;
            overflow-y: auto;
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        /* نافذة الثيرابيست */
        .therapist-message {
            background: var(--gradient-therapist);
            color: white;
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin: 1rem 0;
            animation: slideIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes popIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* تصميم متجاوب */
        @media (max-width: 1024px) {
            .container {
                height: 100vh;
                border-radius: 0;
            }
            
            .sidebar {
                position: absolute;
                left: -100%;
                width: 300px;
                height: 100%;
            }
            
            .sidebar.active {
                left: 0;
            }
        }

        @media (max-width: 768px) {
            .chat-header {
                padding: 1rem;
            }
            
            .messages-container {
                padding: 1rem;
            }
            
            .message-input-container {
                padding: 1rem;
            }
        }

        /* شريط التمرير المخصص */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
    </style>
</head>
<body>
    <!-- نافذة تسجيل الدخول -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-box">
            <div class="tabs">
                <div class="tab active" data-tab="login">تسجيل الدخول</div>
                <div class="tab" data-tab="register">إنشاء حساب</div>
            </div>
            
            <!-- نموذج تسجيل الدخول -->
            <form id="loginForm" style="display: block;">
                <div class="form-group">
                    <input type="text" class="form-control" id="loginUsername" placeholder="اسم المستخدم" required>
                </div>
                <div class="form-group">
                    <input type="password" class="form-control" id="loginPassword" placeholder="كلمة المرور" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">دخول</button>
                
                <div style="text-align: center; margin-top: 1rem; color: #6b7280;">
                    أو
                </div>
                
                <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                    <button type="button" class="btn" style="flex: 1; background: #4285f4; color: white;" onclick="googleLogin()">
                        <i class="fab fa-google"></i> جوجل
                    </button>
                    <button type="button" class="btn" style="flex: 1; background: #1877f2; color: white;">
                        <i class="fab fa-facebook"></i> فيسبوك
                    </button>
                </div>
            </form>
            
            <!-- نموذج التسجيل -->
            <form id="registerForm" style="display: none;">
                <div class="form-group">
                    <input type="text" class="form-control" id="registerUsername" placeholder="اسم المستخدم" required>
                </div>
                <div class="form-group">
                    <input type="email" class="form-control" id="registerEmail" placeholder="البريد الإلكتروني" required>
                </div>
                <div class="form-group">
                    <input type="password" class="form-control" id="registerPassword" placeholder="كلمة المرور" required>
                </div>
                <div class="form-group">
                    <input type="password" class="form-control" id="registerConfirmPassword" placeholder="تأكيد كلمة المرور" required>
                </div>
                <div class="form-group">
                    <select class="form-control" id="registerGender" required>
                        <option value="">اختر الجنس</option>
                        <option value="male">ذكر</option>
                        <option value="female">أنثى</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary btn-block">إنشاء حساب</button>
            </form>
        </div>
    </div>

    <!-- نافذة الإدارة -->
    <div class="admin-panel" id="adminPanel">
        <div style="padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2>لوحة الإدارة</h2>
                <button class="btn" onclick="closeAdminPanel()">إغلاق</button>
            </div>
            
            <div class="tabs" style="margin-bottom: 2rem;">
                <div class="tab active" data-admin-tab="users">المستخدمين</div>
                <div class="tab" data-admin-tab="rooms">الغرف</div>
                <div class="tab" data-admin-tab="reports">التقارير</div>
                <div class="tab" data-admin-tab="settings">الإعدادات</div>
            </div>
            
            <!-- إدارة المستخدمين -->
            <div id="adminUsers" style="display: block;">
                <div style="margin-bottom: 1rem;">
                    <input type="text" class="form-control" placeholder="بحث عن مستخدم..." id="userSearch">
                </div>
                <div id="usersList"></div>
            </div>
            
            <!-- إدارة الغرف -->
            <div id="adminRooms" style="display: none;">
                <button class="btn btn-primary" onclick="createNewRoom()">إنشاء غرفة جديدة</button>
                <div id="roomsList" style="margin-top: 1rem;"></div>
            </div>
        </div>
    </div>

    <!-- تطبيق الدردشة الرئيسي -->
    <div class="container" id="chatContainer" style="display: none;">
        <!-- الشريط الجانبي -->
        <div class="sidebar" id="sidebar">
            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">
                    <img id="userAvatarImg" src="" alt="صورة المستخدم">
                    <div class="online-status"></div>
                </div>
                <div class="username" id="username"></div>
                <div class="user-role" id="userRole">مستخدم</div>
            </div>
            
            <div class="rooms-section">
                <h3 style="margin-bottom: 1rem; color: #9ca3af;">الغرف</h3>
                <ul class="room-list" id="roomList">
                    <!-- سيتم ملؤها ديناميكياً -->
                </ul>
            </div>
        </div>
        
        <!-- منطقة الدردشة الرئيسية -->
        <div class="chat-main">
            <div class="chat-header">
                <div>
                    <h2 id="currentRoomTitle">عام</h2>
                    <p id="currentRoomDesc" style="color: #6b7280;">الغرفة العامة</p>
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn" id="menuBtn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <button class="btn btn-primary" onclick="openAdminPanel()" id="adminBtn" style="display: none;">
                        <i class="fas fa-cog"></i> الإدارة
                    </button>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <!-- الرسائل ستظهر هنا -->
            </div>
            
            <div class="message-input-container">
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" class="form-control" id="messageInput" placeholder="اكتب رسالتك..." autocomplete="off">
                    <button class="btn btn-primary" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // نظام قاعدة البيانات المحلي
        class Database {
            constructor() {
                this.dbName = 'circl_chat_db';
                this.version = 3;
                this.db = null;
                this.init();
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // جدول المستخدمين
                        if (!db.objectStoreNames.contains('users')) {
                            const usersStore = db.createObjectStore('users', { keyPath: 'id' });
                            usersStore.createIndex('username', 'username', { unique: true });
                            usersStore.createIndex('email', 'email', { unique: true });
                            usersStore.createIndex('role', 'role', { unique: false });
                        }
                        
                        // جدول الغرف
                        if (!db.objectStoreNames.contains('rooms')) {
                            const roomsStore = db.createObjectStore('rooms', { keyPath: 'id' });
                            roomsStore.createIndex('name', 'name', { unique: true });
                            roomsStore.createIndex('type', 'type', { unique: false });
                        }
                        
                        // جدول الرسائل
                        if (!db.objectStoreNames.contains('messages')) {
                            const messagesStore = db.createObjectStore('messages', { keyPath: 'id' });
                            messagesStore.createIndex('roomId', 'roomId', { unique: false });
                            messagesStore.createIndex('userId', 'userId', { unique: false });
                            messagesStore.createIndex('timestamp', 'timestamp', { unique: false });
                        }
                        
                        // جدول التذاكر (للثيرابيست)
                        if (!db.objectStoreNames.contains('tickets')) {
                            const ticketsStore = db.createObjectStore('tickets', { keyPath: 'id' });
                            ticketsStore.createIndex('userId', 'userId', { unique: false });
                            ticketsStore.createIndex('status', 'status', { unique: false });
                            ticketsStore.createIndex('createdAt', 'createdAt', { unique: false });
                        }
                        
                        // جدول المستويات والرتب
                        if (!db.objectStoreNames.contains('levels')) {
                            const levelsStore = db.createObjectStore('levels', { keyPath: 'userId' });
                        }
                        
                        // جدول النقاط
                        if (!db.objectStoreNames.contains('points')) {
                            const pointsStore = db.createObjectStore('points', { keyPath: 'userId' });
                        }
                        
                        // إنشاء المستخدم المالك الافتراضي
                        setTimeout(() => {
                            this.createDefaultUsers();
                            this.createDefaultRooms();
                        }, 100);
                    };
                });
            }

            async createDefaultUsers() {
                const ownerUser = {
                    id: 'owner-001',
                    username: 'mvnnooo',
                    email: 'owner@circlchat.com',
                    password: 'mmmmnnnn11',
                    role: 'owner',
                    gender: 'male',
                    avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=mvnnooo&backgroundColor=dc2626`,
                    verified: true,
                    points: 10000,
                    level: 100,
                    joinDate: new Date().toISOString(),
                    permissions: ['all']
                };
                
                await this.addUser(ownerUser);
            }

            async createDefaultRooms() {
                const defaultRooms = [
                    {
                        id: 'room-1',
                        name: 'عام',
                        description: 'الغرفة العامة للجميع',
                        type: 'public',
                        maxUsers: 500,
                        order: 1,
                        createdBy: 'system'
                    },
                    {
                        id: 'room-2',
                        name: 'VIP',
                        description: 'غرفة الأعضاء المميزين',
                        type: 'vip',
                        maxUsers: 100,
                        order: 2,
                        createdBy: 'system',
                        password: '1218'
                    },
                    {
                        id: 'room-3',
                        name: 'ثرابيست',
                        description: 'جلسات الدعم النفسي مع الذكاء الاصطناعي',
                        type: 'therapist',
                        maxUsers: 1,
                        order: 3,
                        createdBy: 'system',
                        isBot: true
                    },
                    {
                        id: 'room-4',
                        name: 'الألعاب',
                        description: 'مناقشة الألعاب والتحديات',
                        type: 'public',
                        maxUsers: 200,
                        order: 4,
                        createdBy: 'system'
                    },
                    {
                        id: 'room-5',
                        name: 'التكنولوجيا',
                        description: 'أحدث التقنيات والبرمجة',
                        type: 'public',
                        maxUsers: 150,
                        order: 5,
                        createdBy: 'system'
                    }
                ];

                for (const room of defaultRooms) {
                    await this.addRoom(room);
                }
            }

            // عمليات المستخدمين
            async addUser(user) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['users'], 'readwrite');
                    const store = transaction.objectStore('users');
                    const request = store.add(user);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getUser(username) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['users'], 'readonly');
                    const store = transaction.objectStore('users');
                    const index = store.index('username');
                    const request = index.get(username);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async updateUser(userId, updates) {
                return new Promise(async (resolve, reject) => {
                    const user = await this.getUserById(userId);
                    if (!user) {
                        reject(new Error('User not found'));
                        return;
                    }
                    
                    const updatedUser = { ...user, ...updates };
                    const transaction = this.db.transaction(['users'], 'readwrite');
                    const store = transaction.objectStore('users');
                    const request = store.put(updatedUser);
                    
                    request.onsuccess = () => resolve(updatedUser);
                    request.onerror = () => reject(request.error);
                });
            }

            async getUserById(userId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['users'], 'readonly');
                    const store = transaction.objectStore('users');
                    const request = store.get(userId);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAllUsers() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['users'], 'readonly');
                    const store = transaction.objectStore('users');
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            // عمليات الغرف
            async addRoom(room) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['rooms'], 'readwrite');
                    const store = transaction.objectStore('rooms');
                    const request = store.add(room);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getRoom(roomId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['rooms'], 'readonly');
                    const store = transaction.objectStore('rooms');
                    const request = store.get(roomId);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAllRooms() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['rooms'], 'readonly');
                    const store = transaction.objectStore('rooms');
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            // عمليات الرسائل
            async addMessage(message) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['messages'], 'readwrite');
                    const store = transaction.objectStore('messages');
                    const request = store.add(message);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getRoomMessages(roomId, limit = 50) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['messages'], 'readonly');
                    const store = transaction.objectStore('messages');
                    const index = store.index('roomId');
                    const request = index.getAll(roomId);
                    
                    request.onsuccess = () => {
                        const messages = request.result
                            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                            .slice(0, limit)
                            .reverse();
                        resolve(messages);
                    };
                    request.onerror = () => reject(request.error);
                });
            }

            // عمليات التذاكر (للثيرابيست)
            async createTicket(userId, issue) {
                const ticket = {
                    id: `ticket-${Date.now()}`,
                    userId,
                    issue,
                    status: 'open',
                    createdAt: new Date().toISOString(),
                    responses: []
                };
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['tickets'], 'readwrite');
                    const store = transaction.objectStore('tickets');
                    const request = store.add(ticket);
                    
                    request.onsuccess = () => resolve(ticket);
                    request.onerror = () => reject(request.error);
                });
            }

            async addTicketResponse(ticketId, response) {
                return new Promise(async (resolve, reject) => {
                    const ticket = await this.getTicket(ticketId);
                    if (!ticket) {
                        reject(new Error('Ticket not found'));
                        return;
                    }
                    
                    ticket.responses.push({
                        ...response,
                        timestamp: new Date().toISOString()
                    });
                    
                    const transaction = this.db.transaction(['tickets'], 'readwrite');
                    const store = transaction.objectStore('tickets');
                    const request = store.put(ticket);
                    
                    request.onsuccess = () => resolve(ticket);
                    request.onerror = () => reject(request.error);
                });
            }

            async getTicket(ticketId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['tickets'], 'readonly');
                    const store = transaction.objectStore('tickets');
                    const request = store.get(ticketId);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getUserTickets(userId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['tickets'], 'readonly');
                    const store = transaction.objectStore('tickets');
                    const index = store.index('userId');
                    const request = index.getAll(userId);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
        }

        // نظام الذكاء الاصطناعي للثيرابيست
        class TherapistAI {
            constructor() {
                this.responses = {
                    greetings: [
                        "مرحباً! أنا مساعدك الذكي للدعم النفسي. كيف يمكنني مساعدتك اليوم؟",
                        "أهلاً وسهلاً بك في جلسة الدعم النفسي. أنا هنا لأستمع إليك وأقدم لك الدعم.",
                        "مرحباً بك! أنا بوت الدعم النفسي، هل لديك أي شيء تريد الحديث عنه؟"
                    ],
                    stress: [
                        "أفهم أنك تشعر بالتوتر. حاول أن تأخذ نفساً عميقاً وتذكر أن كل شيء مؤقت.",
                        "التوتر جزء من الحياة، ولكن يمكننا التعامل معه. هل تريد مشاركة ما يقلقك؟",
                        "جرب تمارين التنفس العميق: شهيق لمدة 4 ثوان، احبس لمدة 7، زفير لمدة 8."
                    ],
                    anxiety: [
                        "القلق طبيعي، لكن عندما يكون مفرطاً فهو يحتاج للاهتمام. هل تحدثت مع أحد عن هذا الشعور؟",
                        "جرب كتابة ما يقلقك على ورقة، هذا يساعد في تنظيم الأفكار وتقليل القلق.",
                        "تذكر أن معظم الأشياء التي تقلقنا لا تحدث أبداً. ركز على الحاضر."
                    ],
                    depression: [
                        "أنا هنا لأستمع إليك. الاكتئاب ليس ضعفاً، وهو قابل للعلاج.",
                        "هل فكرت في التحدث مع مختص نفسي؟ هذا قد يكون مفيداً جداً.",
                        "حاول أن تبدأ بنشاطات صغيرة يومياً، حتى لو كانت بسيطة مثل المشي قليلاً."
                    ],
                    general: [
                        "شكراً لمشاركتك هذا معي. تذكر أن طلب المساعدة علامة قوة، ليس ضعف.",
                        "أنت لست وحدك في هذا. كثيرون مروا بتجارب مشابهة وتخطوها.",
                        "الرعاية الذاتية مهمة. خصص وقتاً لنفسك كل يوم."
                    ]
                };
            }

            async generateResponse(userMessage) {
                // محاكاة معالجة اللغة الطبيعية
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const message = userMessage.toLowerCase();
                let category = 'general';
                
                if (message.includes('مرحبا') || message.includes('اهلا') || message.includes('السلام')) {
                    category = 'greetings';
                } else if (message.includes('توتر') || message.includes('ضغط')) {
                    category = 'stress';
                } else if (message.includes('قلق') || message.includes('خوف')) {
                    category = 'anxiety';
                } else if (message.includes('اكتئاب') || message.includes('حزن')) {
                    category = 'depression';
                }
                
                const responses = this.responses[category];
                return responses[Math.floor(Math.random() * responses.length)];
            }
        }

        // التطبيق الرئيسي
        class ChatApp {
            constructor() {
                this.db = new Database();
                this.therapistAI = new TherapistAI();
                this.currentUser = null;
                this.currentRoom = null;
                this.socket = null;
                this.onlineUsers = new Map();
                this.initialize();
            }

            async initialize() {
                await this.db.init();
                this.setupEventListeners();
                this.checkAutoLogin();
            }

            setupEventListeners() {
                // تبديل التبويبات
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        if (tab.dataset.tab === 'login') {
                            document.getElementById('loginForm').style.display = 'block';
                            document.getElementById('registerForm').style.display = 'none';
                        } else {
                            document.getElementById('loginForm').style.display = 'none';
                            document.getElementById('registerForm').style.display = 'block';
                        }
                    });
                });

                // تسجيل الدخول
                document.getElementById('loginForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.login();
                });

                // التسجيل
                document.getElementById('registerForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.register();
                });

                // إرسال الرسائل
                document.getElementById('sendBtn').addEventListener('click', () => this.sendMessage());
                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });

                // زر القائمة للجوال
                document.getElementById('menuBtn').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('active');
                });

                // تبويبات لوحة الإدارة
                document.querySelectorAll('[data-admin-tab]').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('[data-admin-tab]').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        const tabId = tab.dataset.adminTab;
                        document.querySelectorAll('#adminUsers, #adminRooms, #adminReports, #adminSettings')
                            .forEach(el => el.style.display = 'none');
                        document.getElementById(`admin${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`).style.display = 'block';
                        
                        if (tabId === 'users') this.loadAdminUsers();
                        else if (tabId === 'rooms') this.loadAdminRooms();
                    });
                });
            }

            checkAutoLogin() {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                    this.startApp();
                }
            }

            async login() {
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;

                try {
                    const user = await this.db.getUser(username);
                    if (!user) {
                        this.showNotification('المستخدم غير موجود', 'error');
                        return;
                    }

                    if (user.password !== password) {
                        this.showNotification('كلمة المرور غير صحيحة', 'error');
                        return;
                    }

                    this.currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    this.startApp();
                    this.showNotification(`مرحباً بك ${user.username}!`, 'success');
                } catch (error) {
                    this.showNotification('حدث خطأ في تسجيل الدخول', 'error');
                    console.error(error);
                }
            }

            async register() {
                const username = document.getElementById('registerUsername').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerConfirmPassword').value;
                const gender = document.getElementById('registerGender').value;

                if (password !== confirmPassword) {
                    this.showNotification('كلمات المرور غير متطابقة', 'error');
                    return;
                }

                if (!gender) {
                    this.showNotification('الرجاء اختيار الجنس', 'error');
                    return;
                }

                try {
                    const existingUser = await this.db.getUser(username);
                    if (existingUser) {
                        this.showNotification('اسم المستخدم موجود بالفعل', 'error');
                        return;
                    }

                    const newUser = {
                        id: `user-${Date.now()}`,
                        username,
                        email,
                        password,
                        role: 'user',
                        gender,
                        avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${username}&backgroundColor=6366f1`,
                        verified: false,
                        points: 100,
                        level: 1,
                        joinDate: new Date().toISOString(),
                        permissions: []
                    };

                    await this.db.addUser(newUser);
                    this.showNotification('تم إنشاء الحساب بنجاح!', 'success');
                    
                    // تبديل إلى تسجيل الدخول تلقائياً
                    document.querySelector('[data-tab="login"]').click();
                    document.getElementById('loginUsername').value = username;
                    document.getElementById('loginPassword').value = password;
                } catch (error) {
                    this.showNotification('حدث خطأ في إنشاء الحساب', 'error');
                    console.error(error);
                }
            }

            async googleLogin() {
                // محاكاة تسجيل الدخول بجوجل
                this.showNotification('جارٍ الاتصال بحساب جوجل...', 'info');
                
                // في التطبيق الحقيقي، استخدم Firebase أو Google OAuth
                setTimeout(async () => {
                    const googleUser = {
                        id: `google-${Date.now()}`,
                        username: `user_${Math.floor(Math.random() * 10000)}`,
                        email: `user${Math.floor(Math.random() * 10000)}@gmail.com`,
                        role: 'user',
                        gender: Math.random() > 0.5 ? 'male' : 'female',
                        avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=google${Date.now()}&backgroundColor=4285f4`,
                        verified: true,
                        points: 200,
                        level: 1,
                        joinDate: new Date().toISOString(),
                        permissions: [],
                        isGoogle: true
                    };

                    try {
                        await this.db.addUser(googleUser);
                        this.currentUser = googleUser;
                        localStorage.setItem('currentUser', JSON.stringify(googleUser));
                        this.startApp();
                        this.showNotification('تم تسجيل الدخول بحساب جوجل بنجاح!', 'success');
                    } catch (error) {
                        this.showNotification('حدث خطأ في تسجيل الدخول', 'error');
                    }
                }, 1500);
            }

            startApp() {
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('chatContainer').style.display = 'flex';
                
                this.updateUserProfile();
                this.loadRooms();
                this.connectToSocket();
                
                // إظهار زر الإدارة للمشرفين والمالك
                if (this.currentUser.role === 'owner' || this.currentUser.role === 'admin') {
                    document.getElementById('adminBtn').style.display = 'block';
                }
            }

            updateUserProfile() {
                document.getElementById('username').textContent = this.currentUser.username;
                document.getElementById('userAvatarImg').src = this.currentUser.avatar;
                document.getElementById('userRole').textContent = this.getRoleText(this.currentUser.role);
                document.getElementById('userRole').className = `user-role role-${this.currentUser.role}`;
            }

            getRoleText(role) {
                const roles = {
                    'owner': 'مالك',
                    'admin': 'مشرف',
                    'moderator': 'مراقب',
                    'vip': 'عضو VIP',
                    'user': 'مستخدم'
                };
                return roles[role] || 'مستخدم';
            }

            async loadRooms() {
                const rooms = await this.db.getAllRooms();
                const roomList = document.getElementById('roomList');
                roomList.innerHTML = '';

                // ترتيب الغرف حسب الترتيب المخصص
                rooms.sort((a, b) => a.order - b.order);

                for (const room of rooms) {
                    const li = document.createElement('li');
                    li.className = `room-item ${this.currentRoom?.id === room.id ? 'active' : ''}`;
                    li.innerHTML = `
                        <i class="fas ${room.type === 'vip' ? 'fa-crown' : room.type === 'therapist' ? 'fa-heart' : 'fa-hashtag'}" 
                           style="margin-left: 0.5rem; color: ${room.type === 'vip' ? 'var(--vip)' : room.type === 'therapist' ? 'var(--therapist)' : '#9ca3af'}"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${room.name}</div>
                            <div style="font-size: 0.8rem; color: #9ca3af;">${room.description}</div>
                        </div>
                        ${room.type === 'vip' ? '<span style="color: var(--vip);"><i class="fas fa-lock"></i></span>' : ''}
                    `;

                    li.addEventListener('click', () => this.joinRoom(room));
                    roomList.appendChild(li);
                }

                // الانضمام تلقائياً للغرفة الأولى
                if (rooms.length > 0 && !this.currentRoom) {
                    await this.joinRoom(rooms[0]);
                }
            }

            async joinRoom(room) {
                // التحقق من صلاحيات الوصول للغرفة
                if (room.type === 'vip' && this.currentUser.role !== 'vip' && 
                    this.currentUser.role !== 'admin' && this.currentUser.role !== 'owner') {
                    const password = prompt('هذه غرفة VIP. الرجاء إدخال كلمة المرور:');
                    if (password !== room.password) {
                        this.showNotification('كلمة المرور غير صحيحة', 'error');
                        return;
                    }
                }

                // تحديث الغرفة الحالية
                this.currentRoom = room;
                document.getElementById('currentRoomTitle').textContent = room.name;
                document.getElementById('currentRoomDesc').textContent = room.description;
                
                // تحديث قائمة الغرف
                this.loadRooms();
                
                // تحميل الرسائل
                await this.loadMessages();
                
                // إذا كانت غرفة الثيرابيست، إظهار رسالة ترحيب
                if (room.type === 'therapist') {
                    await this.handleTherapistRoom();
                }
            }

            async loadMessages() {
                const messages = await this.db.getRoomMessages(this.currentRoom.id);
                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';

                if (messages.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #6b7280;">
                            <i class="fas fa-comments" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                            <p>لا توجد رسائل بعد. كن أول من يرسل رسالة!</p>
                        </div>
                    `;
                    return;
                }

                for (const message of messages) {
                    await this.displayMessage(message);
                }

                container.scrollTop = container.scrollHeight;
            }

            async displayMessage(message) {
                const container = document.getElementById('messagesContainer');
                const isCurrentUser = message.userId === this.currentUser?.id;
                const user = await this.db.getUserById(message.userId);
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isCurrentUser ? 'my-message' : ''}`;
                
                const time = new Date(message.timestamp).toLocaleTimeString('ar-EG', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                messageDiv.innerHTML = `
                    ${!isCurrentUser ? `
                        <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; margin-left: 0.5rem;">
                            <img src="${user?.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=user&backgroundColor=ccc'}" 
                                 style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                    ` : ''}
                    
                    <div class="message-content" style="background: ${isCurrentUser ? 'var(--gradient-primary)' : 'white'}; 
                                                         color: ${isCurrentUser ? 'white' : 'inherit'};
                                                         max-width: 70%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-weight: 600;">${user?.username || 'مستخدم'}</span>
                                ${user?.role === 'owner' ? '<span style="background: var(--owner); color: white; padding: 0.1rem 0.5rem; border-radius: 10px; font-size: 0.7rem;">مالك</span>' : ''}
                                ${user?.role === 'admin' ? '<span style="background: var(--admin); color: white; padding: 0.1rem 0.5rem; border-radius: 10px; font-size: 0.7rem;">مشرف</span>' : ''}
                            </div>
                            <span style="font-size: 0.8rem; opacity: 0.7;">${time}</span>
                        </div>
                        <div>${this.escapeHtml(message.text)}</div>
                    </div>
                    
                    ${isCurrentUser ? `
                        <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; margin-right: 0.5rem;">
                            <img src="${this.currentUser.avatar}" 
                                 style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                    ` : ''}
                `;

                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
            }

            async sendMessage() {
                const input = document.getElementById('messageInput');
                const text = input.value.trim();
                
                if (!text || !this.currentRoom || !this.currentUser) return;

                // في غرفة الثيرابيست، معالجة خاصة
                if (this.currentRoom.type === 'therapist') {
                    await this.handleTherapistMessage(text);
                    input.value = '';
                    return;
                }

                const message = {
                    id: `msg-${Date.now()}`,
                    roomId: this.currentRoom.id,
                    userId: this.currentUser.id,
                    text: text,
                    timestamp: new Date().toISOString()
                };

                await this.db.addMessage(message);
                await this.displayMessage(message);
                input.value = '';
                
                // إضافة نقاط للمستخدم
                await this.addUserPoints(5);
            }

            async handleTherapistRoom() {
                const container = document.getElementById('messagesContainer');
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                        <i class="fas fa-heart" style="font-size: 3rem; color: var(--therapist); margin-bottom: 1rem;"></i>
                        <h3 style="color: var(--therapist); margin-bottom: 1rem;">جلسة الدعم النفسي</h3>
                        <p>مرحباً بك في جلسة الدعم النفسي. أنا مساعدك الذكي هنا لأستمع إليك وأقدم لك الدعم.</p>
                        <p style="margin-top: 1rem; font-size: 0.9rem;">يمكنك مشاركة أي شيء يقلقك، وسأحاول مساعدتك.</p>
                    </div>
                `;
            }

            async handleTherapistMessage(userMessage) {
                // إضافة رسالة المستخدم
                const userMsg = {
                    id: `msg-${Date.now()}`,
                    roomId: this.currentRoom.id,
                    userId: this.currentUser.id,
                    text: userMessage,
                    timestamp: new Date().toISOString()
                };

                await this.db.addMessage(userMsg);
                await this.displayMessage(userMsg);

                // إنشاء تذكرة جديدة أو تحديث التذكرة الحالية
                const tickets = await this.db.getUserTickets(this.currentUser.id);
                let openTicket = tickets.find(t => t.status === 'open');
                
                if (!openTicket) {
                    openTicket = await this.db.createTicket(this.currentUser.id, userMessage);
                }

                // توليد رد الذكاء الاصطناعي
                this.showNotification('جاري تحليل رسالتك...', 'info');
                const aiResponse = await this.therapistAI.generateResponse(userMessage);
                
                // إضافة رد البوت
                const botMessage = {
                    id: `msg-${Date.now()}`,
                    roomId: this.currentRoom.id,
                    userId: 'therapist-bot',
                    text: aiResponse,
                    timestamp: new Date().toISOString()
                };

                await this.db.addMessage(botMessage);
                await this.db.addTicketResponse(openTicket.id, {
                    from: 'bot',
                    message: aiResponse
                });

                // عرض رد البوت
                await this.displayMessage(botMessage);
                
                // تحديث حالة التذكرة
                await this.db.updateTicket(openTicket.id, { lastResponse: new Date().toISOString() });
            }

            async addUserPoints(points) {
                if (!this.currentUser) return;
                
                this.currentUser.points += points;
                this.currentUser.level = Math.floor(this.currentUser.points / 100) + 1;
                
                await this.db.updateUser(this.currentUser.id, {
                    points: this.currentUser.points,
                    level: this.currentUser.level
                });
                
                // عرض إشعار للمستويات الكبيرة
                if (points >= 50) {
                    this.showNotification(`🎉 +${points} نقطة!`, 'success');
                }
            }

            connectToSocket() {
                // محاكاة اتصال السوكيت
                this.showNotification('جارٍ الاتصال بالسيرفر...', 'info');
                
                setTimeout(() => {
                    this.showNotification('تم الاتصال بنجاح', 'success');
                    // هنا سيتم تنفيذ اتصال WebSocket الحقيقي
                }, 1000);
            }

            async loadAdminUsers() {
                const users = await this.db.getAllUsers();
                const container = document.getElementById('usersList');
                container.innerHTML = '';

                for (const user of users) {
                    const div = document.createElement('div');
                    div.className = 'user-item';
                    div.style.cssText = `
                        padding: 1rem;
                        border: 1px solid #e5e7eb;
                        border-radius: var(--radius-lg);
                        margin-bottom: 0.5rem;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    `;
                    
                    div.innerHTML = `
                        <div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <img src="${user.avatar}" style="width: 40px; height: 40px; border-radius: 50%;">
                                <div>
                                    <div style="font-weight: 600;">${user.username}</div>
                                    <div style="font-size: 0.8rem; color: #6b7280;">
                                        ${this.getRoleText(user.role)} • المستوى ${user.level}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn" onclick="app.promoteUser('${user.id}')" 
                                    ${this.currentUser?.role !== 'owner' ? 'disabled' : ''}>
                                ترقية
                            </button>
                            <button class="btn" onclick="app.addPoints('${user.id}')"
                                    ${!['owner', 'admin'].includes(this.currentUser?.role) ? 'disabled' : ''}>
                                إضافة نقاط
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(div);
                }
            }

            async loadAdminRooms() {
                const rooms = await this.db.getAllRooms();
                const container = document.getElementById('roomsList');
                container.innerHTML = '';

                for (const room of rooms) {
                    const div = document.createElement('div');
                    div.style.cssText = `
                        padding: 1rem;
                        border: 1px solid #e5e7eb;
                        border-radius: var(--radius-lg);
                        margin-bottom: 0.5rem;
                    `;
                    
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600;">${room.name}</div>
                                <div style="font-size: 0.8rem; color: #6b7280;">${room.description}</div>
                                <div style="font-size: 0.8rem; margin-top: 0.25rem;">
                                    <span style="background: ${room.type === 'public' ? 'var(--primary)' : 
                                                              room.type === 'vip' ? 'var(--vip)' : 
                                                              'var(--therapist)'}; 
                                           color: white; padding: 0.1rem 0.5rem; border-radius: 10px;">
                                        ${room.type === 'public' ? 'عامة' : 
                                          room.type === 'vip' ? 'VIP' : 'ثرابيست'}
                                    </span>
                                </div>
                            </div>
                            <div>
                                <button class="btn" onclick="app.editRoom('${room.id}')">تعديل</button>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(div);
                }
            }

            async promoteUser(userId) {
                if (this.currentUser?.role !== 'owner') {
                    this.showNotification('ليس لديك صلاحية لهذا الإجراء', 'error');
                    return;
                }

                const user = await this.db.getUserById(userId);
                if (!user) return;

                const newRole = prompt('اختر الرتبة الجديدة:', user.role);
                if (!newRole || !['user', 'vip', 'moderator', 'admin', 'owner'].includes(newRole)) {
                    this.showNotification('رتبة غير صالحة', 'error');
                    return;
                }

                await this.db.updateUser(userId, { role: newRole });
                this.showNotification(`تم ترقية ${user.username} إلى ${this.getRoleText(newRole)}`, 'success');
                this.loadAdminUsers();
            }

            async addPoints(userId) {
                if (!['owner', 'admin'].includes(this.currentUser?.role)) {
                    this.showNotification('ليس لديك صلاحية لهذا الإجراء', 'error');
                    return;
                }

                const points = parseInt(prompt('أدخل عدد النقاط:'));
                if (isNaN(points) || points <= 0) {
                    this.showNotification('عدد النقاط غير صالح', 'error');
                    return;
                }

                const user = await this.db.getUserById(userId);
                const newPoints = (user.points || 0) + points;
                await this.db.updateUser(userId, { points: newPoints });
                
                this.showNotification(`تم إضافة ${points} نقطة لـ ${user.username}`, 'success');
                this.loadAdminUsers();
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#3b82f6'};
                    color: white;
                    padding: 12px 24px;
                    border-radius: var(--radius-lg);
                    z-index: 10000;
                    box-shadow: var(--shadow-lg);
                    animation: slideIn 0.3s ease;
                    font-family: 'Tajawal', sans-serif;
                `;
                
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        }

        // وظائف عامة للوصول من الأزرار
        function openAdminPanel() {
            document.getElementById('adminPanel').classList.add('active');
            app.loadAdminUsers();
        }

        function closeAdminPanel() {
            document.getElementById('adminPanel').classList.remove('active');
        }

        function createNewRoom() {
            const name = prompt('اسم الغرفة الجديدة:');
            if (!name) return;
            
            const description = prompt('وصف الغرفة:');
            const type = prompt('نوع الغرفة (public/vip/therapist):', 'public');
            
            if (!['public', 'vip', 'therapist'].includes(type)) {
                app.showNotification('نوع الغرفة غير صالح', 'error');
                return;
            }
            
            // هنا سيتم إضافة الغرفة الجديدة
            app.showNotification('تم إنشاء الغرفة بنجاح', 'success');
            app.loadAdminRooms();
        }

        // تهيئة التطبيق
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new ChatApp();
        });
    </script>
</body>
</html>
