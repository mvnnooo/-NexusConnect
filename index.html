<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circl Chat - Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f9fafb;
            --bronze: #cd7f32;
            --silver: #c0c0c0;
            --gold: #fbbf24;
            --diamond: #60a5fa;
            --king: #a855f7;
            --queen: #ec4899;
            --owner: #dc2626;
            --admin: #059669;
            --moderator: #3b82f6;
            --vip: #f59e0b;
            --therapist: #8b5cf6;
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
            --gradient-secondary: linear-gradient(135deg, #fbbf24 0%, #f97316 100%);
            --gradient-therapist: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --radius: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #1f2937;
            line-height: 1.6;
            padding: 1rem;
        }

        .container {
            width: 100%;
            max-width: 1800px;
            height: 95vh;
            background: white;
            border-radius: var(--radius-2xl);
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            display: flex;
            position: relative;
        }

        /* ========== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ ========== */
        .sidebar {
            width: 350px;
            background: #111827;
            color: white;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .user-profile {
            padding: 1.5rem;
            text-align: center;
            border-bottom: 1px solid #374151;
            background: rgba(255, 255, 255, 0.05);
        }

        .user-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            margin: 0 auto 1rem;
            border: 4px solid var(--primary);
            position: relative;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .online-status {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            background: var(--success);
            border-radius: 50%;
            border: 3px solid #111827;
        }

        .username {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .user-role {
            display: inline-block;
            padding: 0.25rem 1rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .role-owner { background: var(--owner); }
        .role-admin { background: var(--admin); }
        .role-moderator { background: var(--moderator); }
        .role-vip { background: var(--vip); }
        .role-user { background: #6b7280; }

        .level-container {
            padding: 1rem 1.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid #374151;
        }

        .level-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .progress-bar {
            height: 8px;
            background: #374151;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.5s ease;
        }

        .rooms-section {
            padding: 1.5rem;
            flex: 1;
            overflow-y: auto;
        }

        .section-title {
            font-size: 0.875rem;
            color: #9ca3af;
            margin-bottom: 1rem;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
        }

        .room-list {
            list-style: none;
        }

        .room-item {
            display: flex;
            align-items: center;
            padding: 0.875rem;
            border-radius: var(--radius-lg);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .room-item:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.2);
        }

        .room-item.active {
            background: rgba(99, 102, 241, 0.15);
            border-right: 4px solid var(--primary);
        }

        .room-icon {
            margin-left: 0.75rem;
            font-size: 1.25rem;
            color: #9ca3af;
        }

        .room-item.active .room-icon {
            color: var(--primary);
        }

        .room-info {
            flex: 1;
        }

        .room-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .room-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .users-section {
            padding: 1.5rem;
            border-top: 1px solid #374151;
        }

        .user-list {
            list-style: none;
        }

        .user-list-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-list-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .user-list-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            margin-left: 0.75rem;
        }

        .user-list-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ========== Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ========== */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(180deg, #f9fafb 0%, #f3f4f6 100%);
        }

        .chat-header {
            padding: 1.25rem 2rem;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .current-room-info {
            display: flex;
            align-items: center;
        }

        .room-avatar {
            width: 56px;
            height: 56px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 1rem;
            color: white;
            font-size: 1.5rem;
        }

        .room-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .room-desc {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .messages-container {
            flex: 1;
            padding: 1.5rem 2rem;
            overflow-y: auto;
        }

        .message {
            display: flex;
            margin-bottom: 1rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            overflow: hidden;
            margin-left: 1rem;
            flex-shrink: 0;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-content {
            flex: 1;
            background: white;
            padding: 1rem;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow);
            max-width: 70%;
        }

        .message.my-message {
            flex-direction: row-reverse;
        }

        .message.my-message .message-avatar {
            margin-left: 0;
            margin-right: 1rem;
        }

        .message.my-message .message-content {
            background: var(--gradient-primary);
            color: white;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .message-time {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .message.my-message .message-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .message-text {
            line-height: 1.5;
            word-break: break-word;
        }

        .message-input-container {
            padding: 1.5rem 2rem;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            background: #f9fafb;
            border-radius: var(--radius-xl);
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .message-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 0.75rem 1rem;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            outline: none;
            color: #1f2937;
        }

        .send-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--gradient-primary);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        /* ========== Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ========== */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .auth-box {
            background: white;
            padding: 2.5rem;
            border-radius: var(--radius-2xl);
            width: 90%;
            max-width: 500px;
            animation: popIn 0.3s ease;
            box-shadow: var(--shadow-xl);
        }

        @keyframes popIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .auth-title {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 1.75rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 1rem;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-control {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: var(--radius-lg);
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .gender-select {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .gender-option {
            flex: 1;
            text-align: center;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gender-option.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .gender-option i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: var(--radius-lg);
            font-family: 'Tajawal', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .google-btn {
            background: white;
            color: #374151;
            border: 1px solid #e5e7eb;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .google-btn:hover {
            background: #f9fafb;
        }

        /* ========== Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ========== */
        .admin-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 2000;
            overflow-y: auto;
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-header {
            padding: 1.5rem 2rem;
            background: #111827;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-content {
            padding: 2rem;
        }

        .admin-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 1rem;
        }

        .admin-tab {
            padding: 0.75rem 1.5rem;
            background: #f3f4f6;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
        }

        .admin-tab.active {
            background: var(--gradient-primary);
            color: white;
        }

        /* ========== Ù†Ø§ÙØ°Ø© VIP ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1500;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-box {
            background: white;
            padding: 2rem;
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 400px;
            animation: popIn 0.3s ease;
        }

        /* ========== Ø§Ù„ØªØ¬Ø§ÙˆØ¨ Ù…Ø¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª ========== */
        @media (max-width: 1200px) {
            .container {
                height: 100vh;
                max-width: 100%;
                border-radius: 0;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                position: absolute;
                left: -100%;
                width: 85%;
                height: 100%;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .chat-header {
                padding: 1rem;
            }
            
            .messages-container {
                padding: 1rem;
            }
            
            .message-input-container {
                padding: 1rem;
            }
            
            .message-content {
                max-width: 85%;
            }
            
            .auth-box {
                padding: 1.5rem;
                margin: 1rem;
            }
        }

        /* ========== ØªØ®ØµÙŠØµ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± ========== */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        .dark-scrollbar::-webkit-scrollbar-track {
            background: #374151;
        }

        .dark-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
        }

        /* ========== Ø¥Ø¶Ø§ÙØ§Øª ========== */
        .typing-indicator {
            padding: 0.5rem 1rem;
            background: white;
            border-radius: var(--radius-lg);
            margin: 0 2rem;
            box-shadow: var(--shadow);
            display: none;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.25rem;
        }

        .badge-owner { background: var(--owner); color: white; }
        .badge-admin { background: var(--admin); color: white; }
        .badge-moderator { background: var(--moderator); color: white; }
        .badge-vip { background: var(--vip); color: white; }
        .badge-verified { color: #3b82f6; }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { top: -100px; opacity: 0; }
            to { top: 20px; opacity: 1; }
        }

        .notification.error { background: var(--danger); }
        .notification.warning { background: var(--warning); }
        .notification.info { background: var(--info); }

        /* ========== Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© ========== */
        .typing-dots {
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        /* ========== Ù…Ø¤Ø´Ø± Ø§Ù„Ø§ØªØµØ§Ù„ ========== */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 1000;
        }

        .connection-status.disconnected {
            background: var(--danger);
        }
    </style>
</head>
<body>
    <!-- Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
    <div class="connection-status" id="connectionStatus">
        <i class="fas fa-wifi"></i>
        <span>Ù…ØªØµÙ„</span>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-box">
            <div class="auth-title">ğŸš€ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Circl Chat</div>
            
            <div class="tabs">
                <div class="tab active" data-tab="login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
                <div class="tab" data-tab="register">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</div>
            </div>
            
            <!-- Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
            <div id="loginForm">
                <div class="form-group">
                    <input type="text" class="form-control" id="loginUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" autocomplete="username">
                </div>
                
                <div class="form-group">
                    <input type="password" class="form-control" id="loginPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="current-password">
                </div>
                
                <button class="btn btn-primary" id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
                
                <div style="text-align: center; margin: 1.5rem 0; color: #6b7280;">Ø£Ùˆ</div>
                
                <button class="btn google-btn" id="googleLoginBtn">
                    <i class="fab fa-google"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google
                </button>
            </div>
            
            <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
            <div id="registerForm" style="display: none;">
                <div class="form-group">
                    <input type="text" class="form-control" id="registerUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" autocomplete="username">
                </div>
                
                <div class="form-group">
                    <input type="password" class="form-control" id="registerPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="new-password">
                </div>
                
                <div class="form-group">
                    <div class="gender-select">
                        <div class="gender-option selected" data-gender="male">
                            <i class="fas fa-mars"></i>
                            <div>Ø°ÙƒØ±</div>
                        </div>
                        <div class="gender-option" data-gender="female">
                            <i class="fas fa-venus"></i>
                            <div>Ø£Ù†Ø«Ù‰</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="registerBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
                
                <div style="text-align: center; margin: 1.5rem 0; color: #6b7280;">Ø£Ùˆ</div>
                
                <button class="btn google-btn" id="googleRegisterBtn">
                    <i class="fab fa-google"></i> Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google
                </button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© VIP -->
    <div class="modal-overlay" id="vipModal">
        <div class="modal-box">
            <h3 style="text-align: center; margin-bottom: 1rem;">
                <i class="fas fa-crown" style="color: var(--vip);"></i>
                ØºØ±ÙØ© VIP
            </h3>
            <p style="text-align: center; margin-bottom: 1.5rem; color: #6b7280;">
                Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ© Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ù…ÙŠØ²ÙŠÙ†. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:
            </p>
            <input type="password" class="form-control" id="vipPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="margin-bottom: 1rem;">
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn" style="flex: 1; background: #f3f4f6;" onclick="closeVipModal()">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn btn-primary" style="flex: 1;" onclick="enterVipRoom()">Ø¯Ø®ÙˆÙ„</button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-header">
            <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
            <button class="btn" onclick="closeAdminPanel()" style="background: #ef4444; color: white;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
        
        <div class="admin-content">
            <div class="admin-tabs">
                <div class="admin-tab active" data-admin-tab="users">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
                <div class="admin-tab" data-admin-tab="rooms">Ø§Ù„ØºØ±Ù</div>
                <div class="admin-tab" data-admin-tab="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
            </div>
            
            <div id="adminUsers">
                <div style="margin-bottom: 1rem;">
                    <input type="text" class="form-control" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…..." id="adminUserSearch">
                </div>
                <div id="adminUsersList"></div>
            </div>
            
            <div id="adminRooms" style="display: none;">
                <div id="adminRoomsList"></div>
            </div>
            
            <div id="adminReports" style="display: none;">
                <p>Ù‚Ø±ÙŠØ¨Ø§Ù‹: ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</p>
            </div>
        </div>
    </div>

    <!-- ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div class="container" id="chatContainer" style="display: none;">
        <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
        <div class="sidebar dark-scrollbar" id="sidebar">
            <div class="user-profile">
                <div class="user-avatar">
                    <img id="userAvatarImg" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                    <div class="online-status"></div>
                </div>
                <div class="username">
                    <span id="userDisplayName"></span>
                    <i class="fas fa-check-circle badge-verified" id="verifiedBadge" style="display: none;"></i>
                </div>
                <div class="user-role" id="userRole">Ù…Ø³ØªØ®Ø¯Ù…</div>
            </div>
            
            <div class="level-container">
                <div class="level-info">
                    <div style="color: #9ca3af; font-size: 0.875rem;">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ <span id="userLevel">1</span></div>
                    <div style="font-weight: 600; font-size: 0.875rem;" id="userRank">Ù…Ø¨ØªØ¯Ø¦</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="levelProgress" style="width: 0%;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: #9ca3af;">
                    <span id="currentXP">0 XP</span>
                    <span id="nextLevelXP">100 XP</span>
                </div>
            </div>
            
            <div class="rooms-section dark-scrollbar">
                <div class="section-title">
                    <span>Ø§Ù„ØºØ±Ù Ø§Ù„Ù…ØªØ§Ø­Ø©</span>
                    <span id="roomsCount">0</span>
                </div>
                <ul class="room-list" id="roomList"></ul>
            </div>
            
            <div class="users-section dark-scrollbar">
                <div class="section-title">
                    <span>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ†</span>
                    <span id="onlineCount">0</span>
                </div>
                <ul class="user-list" id="userList"></ul>
            </div>
        </div>
        
        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div class="chat-main">
            <div class="chat-header">
                <div class="current-room-info">
                    <div class="room-avatar">
                        <i class="fas fa-users" id="roomIcon"></i>
                    </div>
                    <div>
                        <div class="room-title" id="currentRoomTitle">Ø¹Ø§Ù…</div>
                        <div class="room-desc" id="currentRoomDesc">Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn" id="mobileMenuBtn" style="display: none;">
                        <i class="fas fa-bars"></i>
                    </button>
                    <button class="btn btn-primary" id="adminBtn" style="display: none;">
                        <i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                    </button>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <div style="text-align: center; padding: 3rem; color: #6b7280;">
                    <i class="fas fa-comments" style="font-size: 4rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                    <h3 style="margin-bottom: 0.5rem; color: #111827;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</h3>
                    <p>Ø§Ø®ØªØ± ØºØ±ÙØ© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</p>
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator" style="display: none;">
                <span style="color: #6b7280; font-size: 0.875rem;">
                    <i class="fas fa-pencil-alt" style="margin-left: 0.5rem;"></i>
                    <span id="typingUser">Ù…Ø³ØªØ®Ø¯Ù…</span> ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </span>
            </div>
            
            <div class="message-input-container">
                <div class="input-wrapper">
                    <input type="text" class="message-input" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." autocomplete="off">
                    <button class="send-btn" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== Ù†Ø¸Ø§Ù… Ø®Ø§Ø¯Ù… WebSocket Ù…Ø­Ø§ÙƒØ§Ø© ==========
        // Ù‡Ø°Ø§ Ø³ÙŠÙƒÙˆÙ† Ø®Ø§Ø¯Ù… ÙˆÙ‡Ù…ÙŠ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø­Ù„ÙŠ
        class MockWebSocketServer {
            constructor() {
                this.clients = new Map(); // {socketId: {socket, user, room}}
                this.messages = [];
                this.onlineUsers = new Map(); // {userId: {user, lastSeen, room}}
                this.rooms = new Map(); // {roomId: {users: Set(userId), messages: []}}
                this.setupDefaultRooms();
                this.messageHistory = new Map(); // {roomId: []}
            }

            setupDefaultRooms() {
                const defaultRooms = [
                    { id: 'room-1', name: 'Ø¹Ø§Ù…', description: 'Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹', type: 'public', icon: 'fa-users', order: 1 },
                    { id: 'room-2', name: 'VIP', description: 'ØºØ±ÙØ© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ù…ÙŠØ²ÙŠÙ†', type: 'vip', icon: 'fa-crown', order: 2, password: '1218' },
                    { id: 'room-3', name: 'Ø«Ø±Ø§Ø¨ÙŠØ³Øª', description: 'Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ù†ÙØ³ÙŠ Ù…Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ', type: 'therapist', icon: 'fa-user-md', order: 3, isBot: true },
                    { id: 'room-4', name: 'Ù…ØµØ± ğŸ‡ªğŸ‡¬', description: 'ØºØ±ÙØ© Ù…ØµØ± Ø§Ù„Ù…Ù…ÙŠØ²Ø©', type: 'public', icon: 'fa-flag', order: 4 },
                    { id: 'room-5', name: 'Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨', description: 'Ù…Ù†Ø§Ù‚Ø´Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ§Øª', type: 'public', icon: 'fa-gamepad', order: 5 }
                ];

                defaultRooms.forEach(room => {
                    this.rooms.set(room.id, {
                        ...room,
                        users: new Set(),
                        messages: []
                    });
                });
            }

            // Ù…Ø­Ø§ÙƒØ§Ø© Ø§ØªØµØ§Ù„ WebSocket
            connectClient(user) {
                const socketId = `socket-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                const mockSocket = {
                    id: socketId,
                    emit: (event, data) => {
                        console.log(`Server â†’ Client [${socketId}]:`, event, data);
                    },
                    on: (event, callback) => {
                        // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„
                        console.log(`Client [${socketId}] listening for:`, event);
                    }
                };

                this.clients.set(socketId, { socket: mockSocket, user, room: null });
                this.onlineUsers.set(user.id, { 
                    ...user, 
                    lastSeen: new Date(), 
                    socketId,
                    room: null 
                });

                return { socket: mockSocket, socketId };
            }

            disconnectClient(socketId) {
                const client = this.clients.get(socketId);
                if (client) {
                    if (client.room) {
                        const room = this.rooms.get(client.room);
                        if (room) {
                            room.users.delete(client.user.id);
                            this.broadcastToRoom(client.room, 'user_left', {
                                userId: client.user.id,
                                username: client.user.username,
                                roomId: client.room
                            });
                        }
                    }
                    
                    this.onlineUsers.delete(client.user.id);
                    this.clients.delete(socketId);
                    
                    this.broadcastToAll('online_users', this.getOnlineUsers());
                }
            }

            joinRoom(socketId, roomId, password = null) {
                const client = this.clients.get(socketId);
                if (!client) return { success: false, error: 'Client not found' };

                const room = this.rooms.get(roomId);
                if (!room) return { success: false, error: 'Room not found' };

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„ØºØ±Ù VIP
                if (room.type === 'vip' && room.password && room.password !== password) {
                    return { success: false, error: 'Invalid password' };
                }

                // Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                if (client.room) {
                    const oldRoom = this.rooms.get(client.room);
                    if (oldRoom) {
                        oldRoom.users.delete(client.user.id);
                        this.broadcastToRoom(client.room, 'user_left', {
                            userId: client.user.id,
                            username: client.user.username,
                            roomId: client.room
                        });
                    }
                }

                // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                client.room = roomId;
                room.users.add(client.user.id);
                
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const userInfo = this.onlineUsers.get(client.user.id);
                if (userInfo) {
                    userInfo.room = roomId;
                    userInfo.lastSeen = new Date();
                }

                // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¬Ù…ÙŠØ¹ ÙÙŠ Ø§Ù„ØºØ±ÙØ©
                this.broadcastToRoom(roomId, 'user_joined', {
                    userId: client.user.id,
                    username: client.user.username,
                    avatar: client.user.avatar,
                    role: client.user.role,
                    roomId
                });

                // Ø¥Ø±Ø³Ø§Ù„ ØªØ­Ø¯ÙŠØ« Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
                this.broadcastToAll('online_users', this.getOnlineUsers());

                // Ø¥Ø±Ø³Ø§Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const messages = this.getMessageHistory(roomId);

                return { 
                    success: true, 
                    room: {
                        id: room.id,
                        name: room.name,
                        description: room.description,
                        type: room.type,
                        icon: room.icon,
                        users: Array.from(room.users)
                    },
                    messages
                };
            }

            sendMessage(socketId, messageData) {
                const client = this.clients.get(socketId);
                if (!client || !client.room) return { success: false, error: 'Client not in room' };

                const room = this.rooms.get(client.room);
                if (!room) return { success: false, error: 'Room not found' };

                const message = {
                    id: `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    ...messageData,
                    timestamp: new Date().toISOString()
                };

                // Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
                this.saveMessageToHistory(client.room, message);

                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØºØ±ÙØ© Ø«ÙŠØ±Ø§Ø¨ÙŠØ³ØªØŒ ØªÙˆÙ„ÙŠØ¯ Ø±Ø¯ Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
                if (room.type === 'therapist') {
                    setTimeout(() => {
                        this.generateTherapistResponse(client.room, message);
                    }, 1000);
                }

                // Ø¨Ø« Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ ÙÙŠ Ø§Ù„ØºØ±ÙØ©
                this.broadcastToRoom(client.room, 'new_message', message);

                // Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                this.addUserPoints(client.user.id, 5);

                return { success: true, message };
            }

            generateTherapistResponse(roomId, userMessage) {
                const responses = [
                    "Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„Ù†ÙØ³ÙŠ. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ",
                    "Ø£ÙÙ‡Ù… Ù…Ø´Ø§Ø¹Ø±Ùƒ. Ø¯Ø¹Ù†Ø§ Ù†ØªØ­Ø¯Ø« Ø¹Ù† Ù‡Ø°Ø§ Ø£ÙƒØ«Ø±.",
                    "Ø´ÙƒØ±Ø§Ù‹ Ù„Ù…Ø´Ø§Ø±ÙƒØªÙƒ Ù‡Ø°Ø§ Ù…Ø¹ÙŠ. ØªØ°ÙƒØ± Ø£Ù†Ùƒ Ù„Ø³Øª ÙˆØ­Ø¯Ùƒ.",
                    "Ù‡Ø°Ø§ Ø´Ø¹ÙˆØ± Ø·Ø¨ÙŠØ¹ÙŠ. Ø¯Ø¹Ù†Ø§ Ù†Ø³ØªÙƒØ´Ù Ø·Ø±Ù‚Ø§Ù‹ Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡.",
                    "Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„Ø°Ø§ØªÙŠØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹. Ø®ØµØµ ÙˆÙ‚ØªØ§Ù‹ Ù„Ù†ÙØ³Ùƒ ÙƒÙ„ ÙŠÙˆÙ….",
                    "Ø£Ù‚Ø¯Ø± Ø´Ø¬Ø§Ø¹ØªÙƒ ÙÙŠ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù† Ù‡Ø°Ø§. Ù‡Ø°Ø§ Ø®Ø·ÙˆØ© Ù…Ù‡Ù…Ø© Ù†Ø­Ùˆ Ø§Ù„Ø´ÙØ§Ø¡."
                ];

                const botMessage = {
                    id: `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    roomId,
                    userId: 'therapist-bot',
                    username: 'ğŸ§  Ø«ÙŠØ±Ø§Ø¨ÙŠØ³Øª AI',
                    avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=therapist&backgroundColor=8b5cf6',
                    text: responses[Math.floor(Math.random() * responses.length)],
                    timestamp: new Date().toISOString(),
                    type: 'system'
                };

                this.saveMessageToHistory(roomId, botMessage);
                this.broadcastToRoom(roomId, 'new_message', botMessage);
            }

            saveMessageToHistory(roomId, message) {
                if (!this.messageHistory.has(roomId)) {
                    this.messageHistory.set(roomId, []);
                }
                
                const history = this.messageHistory.get(roomId);
                history.push(message);
                
                // Ø­ÙØ¸ Ø¢Ø®Ø± 100 Ø±Ø³Ø§Ù„Ø© ÙÙ‚Ø·
                if (history.length > 100) {
                    history.shift();
                }
            }

            getMessageHistory(roomId) {
                return this.messageHistory.get(roomId) || [];
            }

            broadcastToRoom(roomId, event, data) {
                const room = this.rooms.get(roomId);
                if (!room) return;

                room.users.forEach(userId => {
                    const userInfo = this.onlineUsers.get(userId);
                    if (userInfo && userInfo.socketId) {
                        const client = this.clients.get(userInfo.socketId);
                        if (client) {
                            client.socket.emit(event, data);
                        }
                    }
                });
            }

            broadcastToAll(event, data) {
                this.clients.forEach(client => {
                    client.socket.emit(event, data);
                });
            }

            getOnlineUsers() {
                return Array.from(this.onlineUsers.values()).map(user => ({
                    id: user.id,
                    username: user.username,
                    avatar: user.avatar,
                    role: user.role,
                    room: user.room,
                    lastSeen: user.lastSeen
                }));
            }

            getRoomUsers(roomId) {
                const room = this.rooms.get(roomId);
                if (!room) return [];

                return Array.from(room.users).map(userId => {
                    const user = this.onlineUsers.get(userId);
                    return user ? {
                        id: user.id,
                        username: user.username,
                        avatar: user.avatar,
                        role: user.role
                    } : null;
                }).filter(Boolean);
            }

            getAllRooms() {
                return Array.from(this.rooms.values()).map(room => ({
                    id: room.id,
                    name: room.name,
                    description: room.description,
                    type: room.type,
                    icon: room.icon,
                    order: room.order,
                    userCount: room.users.size
                }));
            }

            addUserPoints(userId, points) {
                const userInfo = this.onlineUsers.get(userId);
                if (userInfo) {
                    if (!userInfo.points) userInfo.points = 0;
                    userInfo.points += points;
                    userInfo.level = Math.floor(userInfo.points / 100) + 1;
                    
                    // Ø¥Ø±Ø³Ø§Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    const client = this.clients.get(userInfo.socketId);
                    if (client) {
                        client.socket.emit('points_update', {
                            points: userInfo.points,
                            level: userInfo.level
                        });
                    }
                }
            }
        }

        // ========== Ù†Ø¸Ø§Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠ ==========
        class LocalDatabase {
            constructor() {
                this.dbName = 'circl_chat_local';
                this.version = 2;
                this.db = null;
                this.init();
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        if (!db.objectStoreNames.contains('users')) {
                            const usersStore = db.createObjectStore('users', { keyPath: 'id' });
                            usersStore.createIndex('username', 'username', { unique: true });
                        }
                        
                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', { keyPath: 'key' });
                        }
                    };
                });
            }

            async saveUser(user) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['users'], 'readwrite');
                    const store = transaction.objectStore('users');
                    const request = store.put(user);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getUser(username) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['users'], 'readonly');
                    const store = transaction.objectStore('users');
                    const index = store.index('username');
                    const request = index.get(username);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async saveSetting(key, value) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['settings'], 'readwrite');
                    const store = transaction.objectStore('settings');
                    const request = store.put({ key, value });
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getSetting(key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['settings'], 'readonly');
                    const store = transaction.objectStore('settings');
                    const request = store.get(key);
                    
                    request.onsuccess = () => resolve(request.result?.value);
                    request.onerror = () => reject(request.error);
                });
            }
        }

        // ========== Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ù„Ø«ÙŠØ±Ø§Ø¨ÙŠØ³Øª ==========
        class TherapistAI {
            constructor() {
                this.responses = {
                    greetings: [
                        "Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„Ù†ÙØ³ÙŠ. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ",
                        "Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¬Ù„Ø³Ø© Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ù†ÙØ³ÙŠ. Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ø£Ø³ØªÙ…Ø¹ Ø¥Ù„ÙŠÙƒ ÙˆØ£Ù‚Ø¯Ù… Ù„Ùƒ Ø§Ù„Ø¯Ø¹Ù….",
                        "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! Ø£Ù†Ø§ Ø¨ÙˆØª Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ù†ÙØ³ÙŠØŒ Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø£ÙŠ Ø´ÙŠØ¡ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù†Ù‡ØŸ"
                    ],
                    stress: [
                        "Ø£ÙÙ‡Ù… Ø£Ù†Ùƒ ØªØ´Ø¹Ø± Ø¨Ø§Ù„ØªÙˆØªØ±. Ø­Ø§ÙˆÙ„ Ø£Ù† ØªØ£Ø®Ø° Ù†ÙØ³Ø§Ù‹ Ø¹Ù…ÙŠÙ‚Ø§Ù‹ ÙˆØªØ°ÙƒØ± Ø£Ù† ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø¤Ù‚Øª.",
                        "Ø§Ù„ØªÙˆØªØ± Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø­ÙŠØ§Ø©ØŒ ÙˆÙ„ÙƒÙ† ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡. Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ø§ ÙŠÙ‚Ù„Ù‚ÙƒØŸ",
                        "Ø¬Ø±Ø¨ ØªÙ…Ø§Ø±ÙŠÙ† Ø§Ù„ØªÙ†ÙØ³ Ø§Ù„Ø¹Ù…ÙŠÙ‚: Ø´Ù‡ÙŠÙ‚ Ù„Ù…Ø¯Ø© 4 Ø«ÙˆØ§Ù†ØŒ Ø§Ø­Ø¨Ø³ Ù„Ù…Ø¯Ø© 7ØŒ Ø²ÙÙŠØ± Ù„Ù…Ø¯Ø© 8."
                    ],
                    anxiety: [
                        "Ø§Ù„Ù‚Ù„Ù‚ Ø·Ø¨ÙŠØ¹ÙŠØŒ Ù„ÙƒÙ† Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ù…ÙØ±Ø·Ø§Ù‹ ÙÙ‡Ùˆ ÙŠØ­ØªØ§Ø¬ Ù„Ù„Ø§Ù‡ØªÙ…Ø§Ù…. Ù‡Ù„ ØªØ­Ø¯Ø«Øª Ù…Ø¹ Ø£Ø­Ø¯ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø´Ø¹ÙˆØ±ØŸ",
                        "Ø¬Ø±Ø¨ ÙƒØªØ§Ø¨Ø© Ù…Ø§ ÙŠÙ‚Ù„Ù‚Ùƒ Ø¹Ù„Ù‰ ÙˆØ±Ù‚Ø©ØŒ Ù‡Ø°Ø§ ÙŠØ³Ø§Ø¹Ø¯ ÙÙŠ ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø£ÙÙƒØ§Ø± ÙˆØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù‚Ù„Ù‚.",
                        "ØªØ°ÙƒØ± Ø£Ù† Ù…Ø¹Ø¸Ù… Ø§Ù„Ø£Ø´ÙŠØ§Ø¡ Ø§Ù„ØªÙŠ ØªÙ‚Ù„Ù‚Ù†Ø§ Ù„Ø§ ØªØ­Ø¯Ø« Ø£Ø¨Ø¯Ø§Ù‹. Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ø¶Ø±."
                    ],
                    depression: [
                        "Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ø£Ø³ØªÙ…Ø¹ Ø¥Ù„ÙŠÙƒ. Ø§Ù„Ø§ÙƒØªØ¦Ø§Ø¨ Ù„ÙŠØ³ Ø¶Ø¹ÙØ§Ù‹ØŒ ÙˆÙ‡Ùˆ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¹Ù„Ø§Ø¬.",
                        "Ù‡Ù„ ÙÙƒØ±Øª ÙÙŠ Ø§Ù„ØªØ­Ø¯Ø« Ù…Ø¹ Ù…Ø®ØªØµ Ù†ÙØ³ÙŠØŸ Ù‡Ø°Ø§ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù…ÙÙŠØ¯Ø§Ù‹ Ø¬Ø¯Ø§Ù‹.",
                        "Ø­Ø§ÙˆÙ„ Ø£Ù† ØªØ¨Ø¯Ø£ Ø¨Ù†Ø´Ø§Ø·Ø§Øª ØµØºÙŠØ±Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹ØŒ Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª Ø¨Ø³ÙŠØ·Ø© Ù…Ø«Ù„ Ø§Ù„Ù…Ø´ÙŠ Ù‚Ù„ÙŠÙ„Ø§Ù‹."
                    ],
                    general: [
                        "Ø´ÙƒØ±Ø§Ù‹ Ù„Ù…Ø´Ø§Ø±ÙƒØªÙƒ Ù‡Ø°Ø§ Ù…Ø¹ÙŠ. ØªØ°ÙƒØ± Ø£Ù† Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ù„Ø§Ù…Ø© Ù‚ÙˆØ©ØŒ Ù„ÙŠØ³ Ø¶Ø¹Ù.",
                        "Ø£Ù†Øª Ù„Ø³Øª ÙˆØ­Ø¯Ùƒ ÙÙŠ Ù‡Ø°Ø§. ÙƒØ«ÙŠØ±ÙˆÙ† Ù…Ø±ÙˆØ§ Ø¨ØªØ¬Ø§Ø±Ø¨ Ù…Ø´Ø§Ø¨Ù‡Ø© ÙˆØªØ®Ø·ÙˆÙ‡Ø§.",
                        "Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„Ø°Ø§ØªÙŠØ© Ù…Ù‡Ù…Ø©. Ø®ØµØµ ÙˆÙ‚ØªØ§Ù‹ Ù„Ù†ÙØ³Ùƒ ÙƒÙ„ ÙŠÙˆÙ…."
                    ]
                };
            }

            generateResponse(userMessage) {
                return new Promise(resolve => {
                    setTimeout(() => {
                        const message = userMessage.toLowerCase();
                        let category = 'general';
                        
                        if (message.includes('Ù…Ø±Ø­Ø¨Ø§') || message.includes('Ø§Ù‡Ù„Ø§') || message.includes('Ø§Ù„Ø³Ù„Ø§Ù…')) {
                            category = 'greetings';
                        } else if (message.includes('ØªÙˆØªØ±') || message.includes('Ø¶ØºØ·') || message.includes('Ù…ØªÙˆØªØ±')) {
                            category = 'stress';
                        } else if (message.includes('Ù‚Ù„Ù‚') || message.includes('Ø®ÙˆÙ') || message.includes('Ù‚Ù„Ù‚Ø§Ù†')) {
                            category = 'anxiety';
                        } else if (message.includes('Ø§ÙƒØªØ¦Ø§Ø¨') || message.includes('Ø­Ø²Ù†') || message.includes('Ù…ÙƒØªØ¦Ø¨')) {
                            category = 'depression';
                        }
                        
                        const responses = this.responses[category];
                        resolve(responses[Math.floor(Math.random() * responses.length)]);
                    }, 800);
                });
            }
        }

        // ========== ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ==========
        class ChatApp {
            constructor() {
                this.server = new MockWebSocketServer();
                this.localDb = new LocalDatabase();
                this.therapistAI = new TherapistAI();
                this.currentUser = null;
                this.currentRoom = null;
                this.socket = null;
                this.socketId = null;
                this.typingTimeout = null;
                this.onlineUsers = new Map();
                this.rooms = [];
                this.initialize();
            }

            async initialize() {
                try {
                    await this.localDb.init();
                    this.setupEventListeners();
                    this.checkAutoLogin();
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', error);
                    this.showNotification('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 'error');
                }
            }

            setupEventListeners() {
                // ØªØ¨Ø¯ÙŠÙ„ ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        e.preventDefault();
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        const tabId = tab.dataset.tab;
                        if (tabId === 'login') {
                            document.getElementById('loginForm').style.display = 'block';
                            document.getElementById('registerForm').style.display = 'none';
                        } else {
                            document.getElementById('loginForm').style.display = 'none';
                            document.getElementById('registerForm').style.display = 'block';
                        }
                    });
                });

                // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³
                document.querySelectorAll('.gender-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.gender-option').forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                    });
                });

                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                document.getElementById('loginBtn').addEventListener('click', () => this.login());
                document.getElementById('loginUsername').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.login();
                });
                document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.login();
                });

                // Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                document.getElementById('registerBtn').addEventListener('click', () => this.register());
                document.getElementById('registerUsername').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.register();
                });
                document.getElementById('registerPassword').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.register();
                });

                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google
                document.getElementById('googleLoginBtn').addEventListener('click', () => this.googleLogin());
                document.getElementById('googleRegisterBtn').addEventListener('click', () => this.googleRegister());

                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                document.getElementById('sendBtn').addEventListener('click', () => this.sendMessage());
                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù†Ø´Ø·Ø©
                document.getElementById('messageInput').addEventListener('input', () => {
                    this.signalTyping();
                });

                // Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø¬ÙˆØ§Ù„
                document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('active');
                });

                // Ø²Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                document.getElementById('adminBtn').addEventListener('click', () => {
                    this.openAdminPanel();
                });

                // ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                document.querySelectorAll('.admin-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        const tabId = tab.dataset.adminTab;
                        document.querySelectorAll('#adminUsers, #adminRooms, #adminReports')
                            .forEach(el => el.style.display = 'none');
                        document.getElementById(`admin${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`).style.display = 'block';
                        
                        if (tabId === 'users') this.loadAdminUsers();
                        else if (tabId === 'rooms') this.loadAdminRooms();
                    });
                });

                // Ø¨Ø­Ø« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                document.getElementById('adminUserSearch').addEventListener('input', (e) => {
                    this.filterAdminUsers(e.target.value);
                });

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©
                window.addEventListener('resize', () => {
                    this.handleResponsiveDesign();
                });

                // Ø¥ØºÙ„Ø§Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
                document.addEventListener('click', (e) => {
                    if (e.target === document.getElementById('adminPanel')) {
                        this.closeAdminPanel();
                    }
                });

                // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© VIP Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
                document.addEventListener('click', (e) => {
                    if (e.target === document.getElementById('vipModal')) {
                        this.closeVipModal();
                    }
                });

                // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„
                document.addEventListener('click', (e) => {
                    if (window.innerWidth <= 768 && 
                        !document.getElementById('sidebar').contains(e.target) && 
                        !document.getElementById('mobileMenuBtn').contains(e.target)) {
                        document.getElementById('sidebar').classList.remove('active');
                    }
                });
            }

            checkAutoLogin() {
                const savedUser = localStorage.getItem('circl_current_user');
                if (savedUser) {
                    try {
                        this.currentUser = JSON.parse(savedUser);
                        this.startApp();
                    } catch (error) {
                        localStorage.removeItem('circl_current_user');
                    }
                }
            }

            async login() {
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value;

                if (!username || !password) {
                    this.showNotification('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
                    return;
                }

                try {
                    // Ù„Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø®Ø§Øµ
                    if (username === 'mvnnooo' && password === 'mmmmnnnn11') {
                        const ownerUser = {
                            id: 'owner-001',
                            username: 'mvnnooo',
                            password: 'mmmmnnnn11',
                            role: 'owner',
                            gender: 'male',
                            avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=mvnnooo&backgroundColor=dc2626`,
                            verified: true,
                            points: 10000,
                            level: 100
                        };
                        
                        await this.localDb.saveUser(ownerUser);
                        await this.completeLogin(ownerUser);
                        return;
                    }

                    const user = await this.localDb.getUser(username);
                    if (!user) {
                        this.showNotification('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                        return;
                    }

                    if (user.password !== password) {
                        this.showNotification('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
                        return;
                    }

                    await this.completeLogin(user);
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
                    this.showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error');
                }
            }

            async register() {
                const username = document.getElementById('registerUsername').value.trim();
                const password = document.getElementById('registerPassword').value;
                const gender = document.querySelector('.gender-option.selected')?.dataset.gender;

                if (!username || !password) {
                    this.showNotification('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
                    return;
                }

                if (!gender) {
                    this.showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³', 'error');
                    return;
                }

                if (password.length < 4) {
                    this.showNotification('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
                    return;
                }

                try {
                    const existingUser = await this.localDb.getUser(username);
                    if (existingUser) {
                        this.showNotification('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„', 'error');
                        return;
                    }

                    const newUser = {
                        id: `user-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        username,
                        password,
                        role: 'user',
                        gender,
                        avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${username}&backgroundColor=6366f1`,
                        verified: false,
                        points: 100,
                        level: 1,
                        joinDate: new Date().toISOString()
                    };

                    await this.localDb.saveUser(newUser);
                    await this.completeLogin(newUser);
                    this.showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:', error);
                    this.showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨', 'error');
                }
            }

            async googleLogin() {
                this.showNotification('Ø¬Ø§Ø±Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google...', 'info');
                
                setTimeout(async () => {
                    const username = `user_${Math.floor(Math.random() * 10000)}`;
                    const googleUser = {
                        id: `google-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        username,
                        password: 'google_auth',
                        role: 'user',
                        gender: Math.random() > 0.5 ? 'male' : 'female',
                        avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=google${Date.now()}`,
                        verified: true,
                        points: 200,
                        level: 1,
                        joinDate: new Date().toISOString(),
                        isGoogle: true
                    };

                    try {
                        await this.localDb.saveUser(googleUser);
                        await this.completeLogin(googleUser);
                        this.showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    } catch (error) {
                        this.showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error');
                    }
                }, 1500);
            }

            async googleRegister() {
                this.googleLogin();
            }

            async completeLogin(user) {
                this.currentUser = user;
                localStorage.setItem('circl_current_user', JSON.stringify(user));
                
                // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
                document.getElementById('authOverlay').style.display = 'none';
                
                // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                await this.startApp();
                
                this.showNotification(`Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ${user.username}!`, 'success');
            }

            async startApp() {
                // Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
                document.getElementById('chatContainer').style.display = 'flex';
                
                // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                this.updateUserProfile();
                
                // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…
                this.connectToServer();
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙˆØ§Ù„Ù…Ø§Ù„Ùƒ
                if (['owner', 'admin'].includes(this.currentUser.role)) {
                    document.getElementById('adminBtn').style.display = 'block';
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ØªØ¬Ø§ÙˆØ¨
                this.handleResponsiveDesign();
            }

            updateUserProfile() {
                document.getElementById('userDisplayName').textContent = this.currentUser.username;
                document.getElementById('userAvatarImg').src = this.currentUser.avatar;
                document.getElementById('userRole').textContent = this.getRoleText(this.currentUser.role);
                document.getElementById('userRole').className = `user-role role-${this.currentUser.role}`;
                
                // ØªØ­Ø¯ÙŠØ« Ø´Ø§Ø±Ø© Ø§Ù„ØªØ­Ù‚Ù‚
                if (this.currentUser.verified) {
                    document.getElementById('verifiedBadge').style.display = 'inline';
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙˆØ§Ù„Ù†Ù‚Ø§Ø·
                this.updateLevelInfo();
            }

            getRoleText(role) {
                const roles = {
                    'owner': 'Ù…Ø§Ù„Ùƒ',
                    'admin': 'Ù…Ø´Ø±Ù',
                    'moderator': 'Ù…Ø±Ø§Ù‚Ø¨',
                    'vip': 'VIP',
                    'user': 'Ù…Ø³ØªØ®Ø¯Ù…'
                };
                return roles[role] || 'Ù…Ø³ØªØ®Ø¯Ù…';
            }

            updateLevelInfo() {
                const level = this.currentUser.level || 1;
                const points = this.currentUser.points || 0;
                const currentLevelPoints = points % 100;
                const progress = (currentLevelPoints / 100) * 100;
                
                document.getElementById('userLevel').textContent = level;
                document.getElementById('userRank').textContent = this.getRankFromLevel(level);
                document.getElementById('levelProgress').style.width = `${progress}%`;
                document.getElementById('currentXP').textContent = `${points} XP`;
                document.getElementById('nextLevelXP').textContent = `${(level * 100)} XP`;
            }

            getRankFromLevel(level) {
                if (level >= 50) return 'Ù…Ù„Ùƒ';
                if (level >= 40) return 'Ù…Ø§Ø³ÙŠ';
                if (level >= 30) return 'Ø°Ù‡Ø¨ÙŠ';
                if (level >= 20) return 'ÙØ¶ÙŠ';
                if (level >= 10) return 'Ø¨Ø±ÙˆÙ†Ø²ÙŠ';
                return 'Ù…Ø¨ØªØ¯Ø¦';
            }

            connectToServer() {
                this.showNotification('Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…...', 'info');
                
                // Ù…Ø­Ø§ÙƒØ§Ø© Ø§ØªØµØ§Ù„ WebSocket
                setTimeout(() => {
                    const { socket, socketId } = this.server.connectClient(this.currentUser);
                    this.socket = socket;
                    this.socketId = socketId;
                    
                    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
                    this.setupSocketListeners();
                    
                    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                    document.getElementById('connectionStatus').classList.remove('disconnected');
                    document.getElementById('connectionStatus').innerHTML = `
                        <i class="fas fa-wifi"></i>
                        <span>Ù…ØªØµÙ„</span>
                    `;
                    
                    this.showNotification('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±Ù
                    this.loadRooms();
                    
                }, 1000);
            }

            setupSocketListeners() {
                // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
                this.socket.on = (event, callback) => {
                    switch (event) {
                        case 'new_message':
                            // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©
                            setInterval(() => {
                                // Ø³ÙŠØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø®Ù„Ø§Ù„ broadcastToRoom ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…
                            }, 100);
                            break;
                            
                        case 'user_joined':
                            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù†Ø¶Ù…Ø§Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØºØ±ÙØ©
                            break;
                            
                        case 'user_left':
                            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…ØºØ§Ø¯Ø±Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØºØ±ÙØ©
                            break;
                            
                        case 'online_users':
                            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
                            break;
                            
                        case 'points_update':
                            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø·
                            break;
                    }
                };
            }

            async loadRooms() {
                try {
                    this.rooms = this.server.getAllRooms();
                    
                    // ØªØ±ØªÙŠØ¨ Ø§Ù„ØºØ±Ù Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
                    this.rooms.sort((a, b) => a.order - b.order);
                    
                    const roomList = document.getElementById('roomList');
                    roomList.innerHTML = '';
                    
                    for (const room of this.rooms) {
                        const li = document.createElement('li');
                        li.className = 'room-item';
                        if (this.currentRoom && room.id === this.currentRoom.id) {
                            li.classList.add('active');
                        }
                        
                        li.innerHTML = `
                            <i class="fas ${room.icon} room-icon"></i>
                            <div class="room-info">
                                <div class="room-name">${room.name}</div>
                                <div class="room-stats">
                                    <span>${room.description}</span>
                                    <span>(${room.userCount} Ù…Ø³ØªØ®Ø¯Ù…)</span>
                                </div>
                            </div>
                            ${room.type === 'vip' ? '<i class="fas fa-lock" style="color: var(--vip);"></i>' : ''}
                        `;
                        
                        li.addEventListener('click', () => this.joinRoom(room.id));
                        roomList.appendChild(li);
                    }
                    
                    document.getElementById('roomsCount').textContent = this.rooms.length;
                    
                    // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ© Ø§Ù„Ø¹Ø§Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                    if (this.rooms.length > 0 && !this.currentRoom) {
                        await this.joinRoom('room-1');
                    }
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±Ù:', error);
                }
            }

            async joinRoom(roomId) {
                try {
                    const room = this.rooms.find(r => r.id === roomId);
                    if (!room) {
                        this.showNotification('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
                        return;
                    }

                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ØºØ±ÙØ© VIP
                    if (room.type === 'vip' && !['owner', 'admin', 'vip'].includes(this.currentUser.role)) {
                        this.showVipModal(room);
                        return;
                    }

                    const result = this.server.joinRoom(this.socketId, roomId);
                    
                    if (!result.success) {
                        this.showNotification(result.error, 'error');
                        return;
                    }

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                    this.currentRoom = result.room;
                    
                    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    document.getElementById('currentRoomTitle').textContent = room.name;
                    document.getElementById('currentRoomDesc').textContent = room.description;
                    document.getElementById('roomIcon').className = `fas ${room.icon}`;
                    
                    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØºØ±Ù
                    await this.loadRooms();
                    
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                    await this.loadMessages(result.messages);
                    
                    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
                    await this.updateActiveUsers(roomId);
                    
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©:', error);
                    this.showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©', 'error');
                }
            }

            showVipModal(room) {
                window.currentVipRoom = room;
                document.getElementById('vipModal').classList.add('active');
            }

            async enterVipRoom() {
                const password = document.getElementById('vipPassword').value;
                const room = window.currentVipRoom;
                
                if (password === room.password) {
                    // ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ VIP
                    this.currentUser.role = 'vip';
                    await this.localDb.saveUser(this.currentUser);
                    this.updateUserProfile();
                    
                    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØºØ±ÙØ©
                    this.closeVipModal();
                    await this.joinRoom(room.id);
                    this.showNotification('ØªÙ… ØªØ±Ù‚ÙŠØªÙƒ Ø¥Ù„Ù‰ Ø¹Ø¶Ùˆ VIP!', 'success');
                } else {
                    this.showNotification('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
                }
            }

            closeVipModal() {
                document.getElementById('vipModal').classList.remove('active');
                document.getElementById('vipPassword').value = '';
            }

            async loadMessages(messages = []) {
                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';
                
                if (messages.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #6b7280;">
                            <i class="fas fa-comments" style="font-size: 4rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                            <h3 style="margin-bottom: 0.5rem; color: #111827;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ${this.currentRoom.name}!</h3>
                            <p>ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©</p>
                        </div>
                    `;
                    return;
                }
                
                for (const message of messages) {
                    await this.displayMessage(message);
                }
                
                // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
                container.scrollTop = container.scrollHeight;
            }

            async displayMessage(message) {
                const container = document.getElementById('messagesContainer');
                const isCurrentUser = message.userId === this.currentUser.id;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isCurrentUser ? 'my-message' : ''}`;
                
                const time = new Date(message.timestamp).toLocaleTimeString('ar-EG', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                messageDiv.innerHTML = `
                    ${!isCurrentUser ? `
                        <div class="message-avatar">
                            <img src="${message.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=user'}" alt="${message.username || 'Ù…Ø³ØªØ®Ø¯Ù…'}">
                        </div>
                    ` : ''}
                    
                    <div class="message-content">
                        <div class="message-header">
                            <div class="message-sender">
                                ${message.username || 'Ù…Ø³ØªØ®Ø¯Ù…'}
                            </div>
                            <div class="message-time">${time}</div>
                        </div>
                        <div class="message-text">${this.escapeHtml(message.text)}</div>
                    </div>
                    
                    ${isCurrentUser ? `
                        <div class="message-avatar">
                            <img src="${this.currentUser.avatar}" alt="${this.currentUser.username}">
                        </div>
                    ` : ''}
                `;
                
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
            }

            async sendMessage() {
                const input = document.getElementById('messageInput');
                const text = input.value.trim();
                
                if (!text || !this.currentRoom || !this.currentUser) return;

                try {
                    const messageData = {
                        roomId: this.currentRoom.id,
                        userId: this.currentUser.id,
                        username: this.currentUser.username,
                        avatar: this.currentUser.avatar,
                        text: text,
                        type: 'text'
                    };

                    const result = this.server.sendMessage(this.socketId, messageData);
                    
                    if (!result.success) {
                        this.showNotification(result.error, 'error');
                        return;
                    }

                    // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                    await this.displayMessage(result.message);
                    
                    // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
                    input.value = '';
                    
                    // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
                    this.clearTyping();
                    
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
                    this.showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'error');
                }
            }

            async updateActiveUsers(roomId) {
                try {
                    const users = this.server.getRoomUsers(roomId);
                    const userList = document.getElementById('userList');
                    userList.innerHTML = '';
                    
                    for (const user of users) {
                        const li = document.createElement('li');
                        li.className = 'user-list-item';
                        li.innerHTML = `
                            <div class="user-list-avatar">
                                <img src="${user.avatar}" alt="${user.username}">
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 500; font-size: 0.875rem;">${user.username}</div>
                                <div style="font-size: 0.75rem; color: #9ca3af;">${this.getRoleText(user.role)}</div>
                            </div>
                        `;
                        userList.appendChild(li);
                    }
                    
                    document.getElementById('onlineCount').textContent = users.length;
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', error);
                }
            }

            signalTyping() {
                if (!this.currentRoom || !this.currentUser) return;
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
                document.getElementById('typingIndicator').style.display = 'block';
                document.getElementById('typingUser').textContent = this.currentUser.username;
                
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¤Ø´Ø± Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
                clearTimeout(this.typingTimeout);
                this.typingTimeout = setTimeout(() => {
                    document.getElementById('typingIndicator').style.display = 'none';
                }, 3000);
            }

            clearTyping() {
                document.getElementById('typingIndicator').style.display = 'none';
                clearTimeout(this.typingTimeout);
            }

            async openAdminPanel() {
                document.getElementById('adminPanel').classList.add('active');
                await this.loadAdminUsers();
            }

            closeAdminPanel() {
                document.getElementById('adminPanel').classList.remove('active');
            }

            async loadAdminUsers() {
                try {
                    const onlineUsers = this.server.getOnlineUsers();
                    const container = document.getElementById('adminUsersList');
                    container.innerHTML = '';
                    
                    for (const user of onlineUsers) {
                        const div = document.createElement('div');
                        div.className = 'user-admin-item';
                        div.style.cssText = `
                            padding: 1rem;
                            border: 1px solid #e5e7eb;
                            border-radius: var(--radius);
                            margin-bottom: 0.5rem;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        `;
                        
                        div.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <img src="${user.avatar}" style="width: 48px; height: 48px; border-radius: 50%;">
                                <div>
                                    <div style="font-weight: 600;">${user.username}</div>
                                    <div style="font-size: 0.875rem; color: #6b7280;">
                                        ${this.getRoleText(user.role)} â€¢ ${user.room || 'ØºÙŠØ± Ù…ØªØµÙ„'}
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn" onclick="app.promoteUser('${user.id}')" 
                                        style="background: #f3f4f6; padding: 0.5rem 1rem; font-size: 0.875rem;"
                                        ${this.currentUser.role !== 'owner' ? 'disabled' : ''}>
                                    ØªØ±Ù‚ÙŠØ©
                                </button>
                            </div>
                        `;
                        
                        container.appendChild(div);
                    }
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©:', error);
                }
            }

            async loadAdminRooms() {
                try {
                    const rooms = this.server.getAllRooms();
                    const container = document.getElementById('adminRoomsList');
                    container.innerHTML = '';
                    
                    for (const room of rooms) {
                        const div = document.createElement('div');
                        div.style.cssText = `
                            padding: 1rem;
                            border: 1px solid #e5e7eb;
                            border-radius: var(--radius);
                            margin-bottom: 0.5rem;
                        `;
                        
                        div.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="font-weight: 600;">${room.name}</div>
                                <span style="background: ${room.type === 'public' ? 'var(--primary)' : 
                                                          room.type === 'vip' ? 'var(--vip)' : 
                                                          'var(--therapist)'}; 
                                       color: white; padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.75rem;">
                                    ${room.type === 'public' ? 'Ø¹Ø§Ù…Ø©' : 
                                      room.type === 'vip' ? 'VIP' : 'Ø«Ø±Ø§Ø¨ÙŠØ³Øª'}
                                </span>
                            </div>
                            <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.5rem;">${room.description}</div>
                            <div style="font-size: 0.875rem;">
                                <span style="color: #6b7280;">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†:</span> ${room.userCount} | 
                                <span style="color: #6b7280;">Ø§Ù„ØªØ±ØªÙŠØ¨:</span> ${room.order}
                            </div>
                        `;
                        
                        container.appendChild(div);
                    }
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±Ù Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©:', error);
                }
            }

            async promoteUser(userId) {
                if (this.currentUser.role !== 'owner') {
                    this.showNotification('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', 'error');
                    return;
                }

                try {
                    const roles = ['user', 'vip', 'moderator', 'admin'];
                    const currentRole = this.server.onlineUsers.get(userId)?.role || 'user';
                    const currentIndex = roles.indexOf(currentRole);
                    const nextRole = roles[Math.min(currentIndex + 1, roles.length - 1)];
                    
                    const user = this.server.onlineUsers.get(userId);
                    if (user) {
                        user.role = nextRole;
                        
                        this.showNotification(`ØªÙ… ØªØ±Ù‚ÙŠØ© ${user.username} Ø¥Ù„Ù‰ ${this.getRoleText(nextRole)}`, 'success');
                        await this.loadAdminUsers();
                    }
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
                    this.showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
                }
            }

            filterAdminUsers(searchTerm) {
                const items = document.querySelectorAll('.user-admin-item');
                items.forEach(item => {
                    const username = item.querySelector('div > div:nth-child(2) > div:nth-child(1)').textContent.toLowerCase();
                    if (username.includes(searchTerm.toLowerCase())) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }

            handleResponsiveDesign() {
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                if (window.innerWidth <= 768) {
                    mobileMenuBtn.style.display = 'block';
                    document.getElementById('sidebar').classList.remove('active');
                } else {
                    mobileMenuBtn.style.display = 'none';
                    document.getElementById('sidebar').classList.add('active');
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideUp 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
                
                // Ø¥Ø¶Ø§ÙØ© Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø¥Ø®ÙØ§Ø¡
                if (!document.querySelector('#notification-styles')) {
                    const style = document.createElement('style');
                    style.id = 'notification-styles';
                    style.textContent = `
                        @keyframes slideUp {
                            from { top: 20px; opacity: 1; }
                            to { top: -100px; opacity: 0; }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }

            logout() {
                if (this.socketId) {
                    this.server.disconnectClient(this.socketId);
                }
                
                this.currentUser = null;
                this.currentRoom = null;
                this.socket = null;
                this.socketId = null;
                localStorage.removeItem('circl_current_user');
                
                document.getElementById('chatContainer').style.display = 'none';
                document.getElementById('authOverlay').style.display = 'flex';
                
                this.showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'info');
            }
        }

        // ========== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ==========
        let app;

        document.addEventListener('DOMContentLoaded', () => {
            app = new ChatApp();
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ÙˆØµÙˆÙ„ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            window.app = app;
            window.enterVipRoom = () => app.enterVipRoom();
            window.closeVipModal = () => app.closeVipModal();
            window.closeAdminPanel = () => app.closeAdminPanel();
        });

        // Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        document.addEventListener('DOMContentLoaded', () => {
            const logoutBtn = document.createElement('button');
            logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i>';
            logoutBtn.title = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬';
            logoutBtn.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                background: var(--danger);
                color: white;
                border: none;
                cursor: pointer;
                z-index: 1000;
                display: none;
                box-shadow: var(--shadow);
                transition: all 0.3s ease;
            `;
            logoutBtn.onmouseenter = () => {
                logoutBtn.style.transform = 'scale(1.1)';
                logoutBtn.style.boxShadow = 'var(--shadow-lg)';
            };
            logoutBtn.onmouseleave = () => {
                logoutBtn.style.transform = 'scale(1)';
                logoutBtn.style.boxShadow = 'var(--shadow)';
            };
            logoutBtn.onclick = () => app.logout();
            document.body.appendChild(logoutBtn);

            // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            const observer = new MutationObserver(() => {
                if (document.getElementById('chatContainer').style.display !== 'none') {
                    logoutBtn.style.display = 'block';
                } else {
                    logoutBtn.style.display = 'none';
                }
            });

            observer.observe(document.getElementById('chatContainer'), {
                attributes: true,
                attributeFilter: ['style']
            });
        });

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†
        setInterval(() => {
            const statusEl = document.getElementById('connectionStatus');
            if (app && app.socket) {
                statusEl.classList.remove('disconnected');
                statusEl.innerHTML = `
                    <i class="fas fa-wifi"></i>
                    <span>Ù…ØªØµÙ„</span>
                `;
            } else {
                statusEl.classList.add('disconnected');
                statusEl.innerHTML = `
                    <i class="fas fa-wifi-slash"></i>
                    <span>ØºÙŠØ± Ù…ØªØµÙ„</span>
                `;
            }
        }, 5000);
    </script>
</body>
</html>
